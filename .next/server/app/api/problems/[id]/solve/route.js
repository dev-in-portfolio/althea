"use strict";(()=>{var e={};e.id=418,e.ids=[418],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9939:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>c,routeModule:()=>m,serverHooks:()=>b,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>p,runtime:()=>d});var o=r(9303),a=r(8716),i=r(670),n=r(7070),l=r(1103);function u(e){return e.reduce((e,t)=>e+t.duration,0)}let d="nodejs";async function p(e,{params:t}){let r=String((await e.json()).userKey||""),s=t.id;if(!r)return n.NextResponse.json({error:"userKey required"},{status:400});let o=(0,l.M)(),a=await o.query("SELECT params FROM problems WHERE id = $1 AND user_key = $2",[s,r]);if(!a.rows.length)return n.NextResponse.json({error:"not found"},{status:404});let i=function(e,t){let r=t.filter(e=>e.must),s=t.filter(e=>!e.must),o=u(r);if(o>e)return{conflict:!0,message:`Must tasks need ${o} minutes but only ${e} are available.`,conflictDetails:{mustTotal:o,available:e,overload:o-e,mustTasks:r.map(e=>({label:e.label,duration:e.duration}))},solutions:[]};let a=e-o,i=[{rule:"Shortest-first",list:[...s].sort((e,t)=>e.duration-t.duration)},{rule:"Longest-first",list:[...s].sort((e,t)=>t.duration-e.duration)},{rule:"Alphabetical",list:[...s].sort((e,t)=>e.label.localeCompare(t.label))},{rule:"Balanced",list:[...s].sort((e,t)=>Math.abs(e.duration-45)-Math.abs(t.duration-45))}],n=[];for(let e of i){var l,d;let t=[...r],s=a;for(let r of e.list)r.duration<=s&&(t.push(r),s-=r.duration);n.push({tasks:t,remaining:s,explanation:(l=e.rule,d=s,[`Rule: ${l}.`,`Selected ${t.length} tasks totaling ${u(t)} minutes.`,`Remaining time: ${d} minutes.`])})}return{conflict:!1,message:"ok",solutions:(function(e){let t=new Set,r=[];for(let s of e){let e=s.tasks.map(e=>e.id).sort().join("|");t.has(e)||(t.add(e),r.push(s))}return r})(n).sort((t,r)=>{let s=e-t.remaining,o=e-r.remaining;return o!==s?o-s:t.tasks.length-r.tasks.length}).slice(0,10)}}(Number(a.rows[0].params?.availableMinutes||0),(await o.query("SELECT id, label, duration_min, must FROM tasks WHERE problem_id = $1 AND user_key = $2",[s,r])).rows.map(e=>({id:e.id,label:e.label,duration:e.duration_min,must:e.must}))),d=await o.connect();try{await d.query("BEGIN"),await d.query("DELETE FROM solutions WHERE problem_id = $1 AND user_key = $2",[s,r]);let e=1;for(let t of i.solutions)await d.query("INSERT INTO solutions (id, problem_id, user_key, rank, payload) VALUES ($1, $2, $3, $4, $5)",[crypto.randomUUID(),s,r,e,t]),e+=1;await d.query("COMMIT")}catch{await d.query("ROLLBACK")}finally{d.release()}return n.NextResponse.json(i)}let m=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/problems/[id]/solve/route",pathname:"/api/problems/[id]/solve",filename:"route",bundlePath:"app/api/problems/[id]/solve/route"},resolvedPagePath:"/root/althea/app/api/problems/[id]/solve/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:f,serverHooks:b}=m,h="/api/problems/[id]/solve/route";function g(){return(0,i.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:f})}},1103:(e,t,r)=>{r.d(t,{M:()=>a});let s=require("pg"),o=null;function a(){if(!o){if(!process.env.DATABASE_URL)throw Error("DATABASE_URL is not set");o=new s.Pool({connectionString:process.env.DATABASE_URL,max:5})}return o}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972],()=>r(9939));module.exports=s})();