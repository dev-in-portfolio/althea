---
import Base from '../layouts/Base.astro';
---
<Base title="Recent">
  <h1>Recently Viewed</h1>
  <div id="recent-root" class="list"></div>
  <script>
    const root = document.getElementById('recent-root');
    const useBackend = (import.meta.env.PUBLIC_USE_BACKEND ?? 'true') === 'true';

    function getUserKey() {
      let key = localStorage.getItem('user-key');
      if (!key) {
        key = crypto.randomUUID();
        localStorage.setItem('user-key', key);
      }
      return key;
    }

    function getLocal() {
      return JSON.parse(localStorage.getItem('recent') || '[]');
    }

    function render(items) {
      root.innerHTML = '';
      if (!items.length) {
        root.innerHTML = '<div class="notice">No recent views yet.</div>';
        return;
      }
      items.forEach((row) => {
        const a = document.createElement('a');
        a.className = 'card';
        a.href = `/exhibits/${row.exhibit_slug || row}`;
        a.textContent = row.exhibit_slug || row;
        root.appendChild(a);
      });
    }

    async function loadBackend() {
      const userKey = getUserKey();
      const res = await fetch(`/api/recent?userKey=${encodeURIComponent(userKey)}`);
      if (!res.ok) throw new Error('backend');
      const data = await res.json();
      return data.items || [];
    }

    async function init() {
      try {
        if (!useBackend) throw new Error('backend disabled');
        const items = await loadBackend();
        render(items);
      } catch (e) {
        render(getLocal());
      }
    }

    init();
  </script>
</Base>
