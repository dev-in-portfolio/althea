---
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#f4ecd8" />
    <title>Codex of Hieroglyphs</title>
  </head>

  <body>
    <main class="wrap">
      <header class="hero">
        <div class="title">
          <h1>Codex of Hieroglyphs</h1>
          <p class="sub">Scribe notebook view with sourced sign references.</p>
        </div>

        <section class="panel" aria-label="Search panel">
          <div class="panel-row">
            <label class="search">
              <span>Search</span>
              <input id="q" type="search" placeholder="Gardiner, Unicode name, meaning, transliteration…" autocomplete="off" />
            </label>

            <div class="stats" aria-live="polite">
              <span id="count">0</span> / <span id="total">0</span>
            </div>
          </div>

          <div class="panel-row scope">
            <div class="scope-label">Scope</div>
            <div class="scope-options" role="radiogroup" aria-label="Search scope">
              <button class="seg active" data-scope="all" role="radio" aria-checked="true">All</button>
              <button class="seg" data-scope="gardiner" role="radio" aria-checked="false">Gardiner</button>
              <button class="seg" data-scope="unicode" role="radio" aria-checked="false">Unicode</button>
              <button class="seg" data-scope="meaning" role="radio" aria-checked="false">Meaning</button>
              <button class="seg" data-scope="transliteration" role="radio" aria-checked="false">Translit</button>
              <button class="seg" data-scope="description" role="radio" aria-checked="false">Description</button>
              <button class="seg" data-scope="category" role="radio" aria-checked="false">Category</button>
            </div>
          </div>

          <div class="panel-row actions">
            <div class="action-pills" role="group" aria-label="Quick actions">
              <button class="pill" id="openCategories">Categories</button>
              <button class="pill" id="toggleFavorites" aria-pressed="false">Favorites</button>
              <button class="pill" id="openReview">Review Mode</button>
              <button class="pill" id="randomGlyph">Random Glyph</button>
              <button class="pill" id="debugToggle" aria-pressed="false">Debug</button>
            </div>
          </div>
        </section>
      </header>

      <section class="grid" id="grid" aria-live="polite"></section>

      <dialog id="categoryModal" class="modal">
        <form method="dialog" class="modal-inner" id="categoryForm">
          <div class="modal-head">
            <div>
              <div class="mTitle">Categories</div>
              <div class="mSub">Filter by Gardiner category.</div>
            </div>
            <button class="close" value="close" aria-label="Close">✕</button>
          </div>

          <div class="modal-controls">
            <label class="search small">
              <span>Search categories</span>
              <input id="catSearch" type="search" placeholder="A, Man, Birds…" autocomplete="off" />
            </label>
            <label class="check">
              <input type="checkbox" id="catFavoritesOnly" />
              <span>Favorites only</span>
            </label>
            <button type="button" class="btn ghost" id="catClear">Clear</button>
          </div>

          <ul class="category-list" id="categoryList"></ul>
        </form>
      </dialog>

      <dialog id="detailModal" class="modal">
        <form method="dialog" class="modal-inner modal-wide">
          <div class="modal-head">
            <div>
              <div id="mId" class="mId"></div>
              <div id="mName" class="mName"></div>
              <div id="mCat" class="mCat"></div>
            </div>
            <button class="close" value="close" aria-label="Close">✕</button>
          </div>

          <div class="mCode glyph" id="mCode" aria-hidden="true"></div>
          <div class="detail-actions glyph-actions">
            <button type="button" class="btn ghost" data-copy="glyph">Copy glyph</button>
          </div>

          <div class="detail-section">
            <div class="detail-label">Core identifiers</div>
            <div class="detail-grid">
              <div>
                <div class="detail-key">Codepoint</div>
                <div class="detail-value" id="mCodepoint"></div>
              <div class="detail-actions">
                <button type="button" class="btn ghost" data-copy="codepoint">Copy</button>
              </div>
              </div>
              <div>
                <div class="detail-key">Gardiner</div>
                <div class="detail-value" id="mGardiner"></div>
              <div class="detail-actions">
                <button type="button" class="btn ghost" data-copy="gardiner">Copy</button>
              </div>
              </div>
              <div>
                <div class="detail-key">Category</div>
                <div class="detail-value" id="mCategory"></div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-label">Unicode name</div>
            <div class="detail-row">
              <div class="detail-value" id="mUnicodeName"></div>
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-label">Meaning</div>
            <div id="mMeanings" class="detail-list"></div>
          </div>

          <div class="detail-section">
            <div class="detail-label">Transliteration</div>
            <div id="mTransliterations" class="detail-list"></div>
          </div>

          <div class="detail-section">
            <div class="detail-label">Description</div>
            <div id="mDescription" class="detail-list"></div>
          </div>

          <div class="detail-section">
            <div class="detail-label">Notes / Usage / Classifier</div>
            <div id="mClassifiers" class="detail-list"></div>
          </div>

          <div class="modal-actions">
            <button value="close" class="btn ghost">Close</button>
          </div>
        </form>
      </dialog>

    </main>

    <div class="toast" id="toast" aria-live="polite"></div>

    <dialog id="debugPanel" class="modal">
      <form method="dialog" class="modal-inner">
        <div class="modal-head">
          <div>
            <div class="mTitle">Debug Info</div>
            <div class="mSub">Copy this and send it.</div>
          </div>
          <button class="close" value="close" aria-label="Close">✕</button>
        </div>
        <div class="detail-section">
          <pre id="debugContent" class="debug-content"></pre>
          <div class="detail-actions">
            <button type="button" class="btn" id="debugCopyInline">Copy Debug</button>
            <button type="button" class="btn ghost" id="debugHighlightFixed">Highlight Fixed</button>
          </div>
        </div>
      </form>
    </dialog>

    <script type="module">
      const q = document.getElementById("q");
      const grid = document.getElementById("grid");
      const count = document.getElementById("count");
      const total = document.getElementById("total");
      const scopeButtons = Array.from(document.querySelectorAll(".seg"));
      const openCategories = document.getElementById("openCategories");
      const categoryModal = document.getElementById("categoryModal");
      const categoryList = document.getElementById("categoryList");
      const catSearch = document.getElementById("catSearch");
      const catFavoritesOnly = document.getElementById("catFavoritesOnly");
      const catClear = document.getElementById("catClear");
      const toggleFavorites = document.getElementById("toggleFavorites");
      const openReview = document.getElementById("openReview");
      const randomGlyph = document.getElementById("randomGlyph");
      const debugToggle = document.getElementById("debugToggle");
      const toast = document.getElementById("toast");
      const debugPanel = document.getElementById("debugPanel");
      const debugContent = document.getElementById("debugContent");
      const debugCopyInline = document.getElementById("debugCopyInline");
      const debugHighlightFixed = document.getElementById("debugHighlightFixed");

      const detailModal = document.getElementById("detailModal");
      const mId = document.getElementById("mId");
      const mName = document.getElementById("mName");
      const mCat = document.getElementById("mCat");
      const mCode = document.getElementById("mCode");
      const mCodepoint = document.getElementById("mCodepoint");
      const mGardiner = document.getElementById("mGardiner");
      const mCategory = document.getElementById("mCategory");
      const mUnicodeName = document.getElementById("mUnicodeName");
      const mMeanings = document.getElementById("mMeanings");
      const mTransliterations = document.getElementById("mTransliterations");
      const mDescription = document.getElementById("mDescription");
      const mClassifiers = document.getElementById("mClassifiers");

      const storageKey = "codex:favorites";
      const state = {
        scope: "all",
        category: "",
        favoritesOnly: false,
        query: ""
      };

      let signs = [];
      let favorites = new Set(JSON.parse(localStorage.getItem(storageKey) || "[]"));
      let currentSign = null;

      function norm(s){ return (s || "").toString().toLowerCase(); }

      function showToast(message){
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 1400);
      }

      function collectDebugInfo(){
        const cards = Array.from(grid.querySelectorAll(".card"));
        const visible = cards.filter((c) => c.style.display !== "none");
        const first = visible[0];
        const rect = first?.getBoundingClientRect();
        const headerPill = document.querySelector(".action-pills .pill");
        const cardPill = first?.querySelector(".pill");
        const pick = (el) => {
          if(!el) return null;
          const cs = getComputedStyle(el);
          return {
            className: el.className,
            text: el.textContent?.trim() || "",
            fontSize: cs.fontSize,
            fontWeight: cs.fontWeight,
            letterSpacing: cs.letterSpacing,
            textTransform: cs.textTransform,
            padding: cs.padding,
            borderRadius: cs.borderRadius,
            background: cs.backgroundImage || cs.backgroundColor,
            border: cs.border,
            boxShadow: cs.boxShadow,
            appearance: cs.appearance || cs.webkitAppearance || ""
          };
        };
        const fixedEls = Array.from(document.querySelectorAll("*")).filter((el) => {
          const cs = getComputedStyle(el);
          return cs.position === "fixed" && el.offsetParent !== null;
        }).map((el) => {
          const r = el.getBoundingClientRect();
          return {
            tag: el.tagName.toLowerCase(),
            id: el.id || "",
            className: el.className || "",
            rect: { x: Math.round(r.x), y: Math.round(r.y), w: Math.round(r.width), h: Math.round(r.height) }
          };
        });
        return {
          url: location.href,
          userAgent: navigator.userAgent,
          viewport: { w: window.innerWidth, h: window.innerHeight },
          devicePixelRatio: window.devicePixelRatio,
          totalSigns: signs.length,
          visibleCards: visible.length,
          headerPill: pick(headerPill),
          cardPill: pick(cardPill),
          fixedElements: fixedEls,
          firstCard: first ? {
            classes: first.className,
            id: first.dataset.idx,
            size: rect ? { w: Math.round(rect.width), h: Math.round(rect.height) } : null,
            html: first.innerHTML.slice(0, 2000)
          } : null
        };
      }

      function saveFavorites(){
        localStorage.setItem(storageKey, JSON.stringify(Array.from(favorites)));
      }

      function missingText(missing){
        if(!missing) return "";
        const needs = Array.isArray(missing.needsSources) && missing.needsSources.length
          ? ` Needs: ${missing.needsSources.join(", ")}.`
          : "";
        return `${missing.reason}${needs}`;
      }

      function renderValue(text, missing){
        if(text && text.length){
          const span = document.createElement("span");
          span.textContent = text;
          return span;
        }
        const wrap = document.createElement("div");
        wrap.className = "missing";
        wrap.textContent = missing ? `— ${missingText(missing)}` : "—";
        return wrap;
      }

      function renderList(items, missing){
        if(!items || !items.length){
          const div = document.createElement("div");
          div.className = "missing";
          div.textContent = missing ? `— ${missingText(missing)}` : "—";
          return div;
        }
        const ul = document.createElement("ul");
        ul.className = "bullet";
        items.forEach((item) => {
          const li = document.createElement("li");
          const span = document.createElement("span");
          span.textContent = item.text;
          li.appendChild(span);
        // sources removed
          ul.appendChild(li);
        });
        return ul;
      }

      function matchesScope(sign, term){
        if(!term) return true;
        const gardiner = norm(sign.gardiner?.code);
        const unicode = norm(sign.unicode?.name);
        const meaning = norm(sign.meanings?.map((m) => m.text).join(" "));
        const translit = norm(sign.transliterations?.map((t) => t.text).join(" "));
        const desc = norm(sign.description?.text);
        const category = norm(sign.gardiner?.categoryLabel);
        const all = [gardiner, unicode, meaning, translit, desc, category].join(" ");

        switch(state.scope){
          case "gardiner": return gardiner.includes(term);
          case "unicode": return unicode.includes(term);
          case "meaning": return meaning.includes(term);
          case "transliteration": return translit.includes(term);
          case "description": return desc.includes(term);
          case "category": return category.includes(term);
          default: return all.includes(term);
        }
      }

      function applyFilter(){
        const term = norm(state.query).trim();
        let visible = 0;
        const cards = Array.from(grid.querySelectorAll(".card"));
        cards.forEach((card) => {
          const idx = Number(card.dataset.idx);
          const sign = signs[idx];
          const inCategory = !state.category || sign.gardiner?.categoryLabel === state.category;
          const isFav = favorites.has(sign.id);
          const matchesFav = !state.favoritesOnly || isFav;
          const matchesSearch = matchesScope(sign, term);
          const ok = inCategory && matchesFav && matchesSearch;
          card.style.display = ok ? "" : "none";
          if(ok) visible++;
        });
        count.textContent = String(visible);
      }

      function setScope(scope){
        state.scope = scope;
        scopeButtons.forEach((btn) => {
          const active = btn.dataset.scope === scope;
          btn.classList.toggle("active", active);
          btn.setAttribute("aria-checked", String(active));
        });
        applyFilter();
      }

      function updateFavUI(){
        const cards = Array.from(grid.querySelectorAll(".card"));
        cards.forEach((card) => {
          const sign = signs[Number(card.dataset.idx)];
          const btn = card.querySelector('[data-action="fav"]');
          const isFav = favorites.has(sign.id);
          card.classList.toggle("is-fav", isFav);
          if(btn){
            btn.setAttribute("aria-pressed", String(isFav));
            btn.classList.toggle("active", isFav);
          }
        });
      }

      function renderGrid(){
        grid.innerHTML = "";
        const fragment = document.createDocumentFragment();
        signs.forEach((sign, idx) => {
          const card = document.createElement("article");
          card.className = "card";
          card.dataset.idx = String(idx);

          const head = document.createElement("div");
          head.className = "card-head";
          const glyphWrap = document.createElement("div");
          glyphWrap.className = "glyphWrap";
          const glyph = document.createElement("div");
          glyph.className = "glyph";
          glyph.textContent = sign.codepoint?.char || "";
          glyphWrap.appendChild(glyph);
          head.appendChild(glyphWrap);

          const meta = document.createElement("div");
          meta.className = "meta";
          const id = document.createElement("div");
          id.className = "id";
          id.textContent = sign.gardiner?.code || sign.codepoint?.hex || sign.id;
          const name = document.createElement("div");
          name.className = "name card-title";
          name.textContent = sign.unicode?.name || "—";
          const category = document.createElement("div");
          category.className = "category";
          category.textContent = sign.gardiner ? `${sign.gardiner.categoryKey} — ${sign.gardiner.categoryLabel}` : "Unclassified";
          meta.appendChild(id);
          meta.appendChild(name);
          meta.appendChild(category);

          const lines = document.createElement("div");
          lines.className = "lines card-body";
          const cp = document.createElement("div");
          cp.className = "line";
          cp.textContent = `Codepoint: ${sign.codepoint?.hex || "—"}`;
          const meaning = document.createElement("div");
          meaning.className = "line";
          meaning.textContent = `Meaning: ${sign.meanings?.length ? sign.meanings.map((m) => m.text).join("; ") : "—"}`;
          const translit = document.createElement("div");
          translit.className = "line";
          translit.textContent = `Translit: ${sign.transliterations?.length ? sign.transliterations.map((t) => t.text).join("; ") : "—"}`;
          lines.appendChild(cp);
          lines.appendChild(meaning);
          lines.appendChild(translit);

          const actions = document.createElement("div");
          actions.className = "actions";
          const open = document.createElement("button");
          open.className = "pill card-pill";
          open.dataset.action = "open";
          open.textContent = "Open";
          const copy = document.createElement("button");
          copy.className = "pill card-pill";
          copy.dataset.action = "copy";
          copy.textContent = "Copy";
          const fav = document.createElement("button");
          fav.className = "pill card-pill fav";
          fav.dataset.action = "fav";
          fav.textContent = "★";
          actions.appendChild(open);
          actions.appendChild(copy);
          actions.appendChild(fav);

          card.appendChild(head);
          card.appendChild(meta);
          card.appendChild(lines);
          card.appendChild(actions);
          stripUnexpectedGlyphs(card);
          fragment.appendChild(card);
        });
        grid.appendChild(fragment);
        updateFavUI();
        applyFilter();
      }

      function stripUnexpectedGlyphs(card){
        const ranges = [
          [0x13000, 0x1342f],
          [0x13460, 0x1347f],
        ];
        const hasGlyph = (text) => {
          for(const ch of text){
            const cp = ch.codePointAt(0);
            if(ranges.some(([a,b]) => cp >= a && cp <= b)) return true;
          }
          return false;
        };
        const stripGlyphs = (text) => {
          let out = "";
          for(const ch of text){
            const cp = ch.codePointAt(0);
            if(ranges.some(([a,b]) => cp >= a && cp <= b)) continue;
            out += ch;
          }
          return out;
        };
        const walker = document.createTreeWalker(
          card,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode(node){
              if(!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
              const parent = node.parentElement;
              if(parent && parent.closest(".glyph")) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          }
        );
        const textNodes = [];
        while(walker.nextNode()){
          textNodes.push(walker.currentNode);
        }
        textNodes.forEach((node) => {
          if(hasGlyph(node.nodeValue)){
            node.nodeValue = stripGlyphs(node.nodeValue);
          }
        });
      }

      function buildCategoryList(){
        categoryList.innerHTML = "";
        const map = new Map();
        signs.forEach((s) => {
          const label = s.gardiner?.categoryLabel || "Unclassified";
          const code = s.gardiner?.categoryKey || "?";
          const key = `${code}::${label}`;
          const prev = map.get(key) || { code, label, count: 0 };
          prev.count += 1;
          map.set(key, prev);
        });
        const list = Array.from(map.values()).sort((a, b) => a.label.localeCompare(b.label, "en", { numeric: true }));

        list.forEach((c) => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "category-item";
          btn.dataset.category = c.code;
          btn.dataset.label = c.label;

          const label = document.createElement("span");
          label.className = "cat-label";
          label.textContent = `${c.label}`;
          btn.appendChild(label);
          li.appendChild(btn);
          categoryList.appendChild(li);
        });
      }

      function openDetail(index){
        const sign = signs[index];
        if(!sign) return;
        currentSign = sign;
        mId.textContent = sign.id;
        mName.textContent = sign.unicode?.name || "—";
        mCat.textContent = sign.gardiner ? `${sign.gardiner.categoryKey} — ${sign.gardiner.categoryLabel}` : "Unclassified";
        mCode.textContent = sign.codepoint?.char || "";

        mCodepoint.innerHTML = "";
        mCodepoint.appendChild(renderValue(sign.codepoint?.hex || "", null));

        mGardiner.innerHTML = "";
        mGardiner.appendChild(renderValue(sign.gardiner?.code || "", sign.missing?.gardiner));

        mCategory.textContent = sign.gardiner ? `${sign.gardiner.categoryKey} — ${sign.gardiner.categoryLabel}` : "Unclassified";

        mUnicodeName.innerHTML = "";
        mUnicodeName.appendChild(renderValue(sign.unicode?.name || "", sign.missing?.unicodeName));

        mMeanings.innerHTML = "";
        mMeanings.appendChild(renderList(sign.meanings, sign.missing?.meanings));

        mTransliterations.innerHTML = "";
        mTransliterations.appendChild(renderList(sign.transliterations, sign.missing?.transliterations));

        mDescription.innerHTML = "";
        mDescription.appendChild(renderList(sign.description?.text ? [{ text: sign.description.text, sources: sign.description.sources }] : [], sign.missing?.description));

        mClassifiers.innerHTML = "";
        const noteItems = [
          ...(sign.classifiers || []),
          ...(sign.notes || []),
          ...(sign.usage || [])
        ];
        mClassifiers.appendChild(renderList(noteItems, sign.missing?.notes || sign.missing?.classifiers));

        detailModal.showModal();
      }

      function updateCategoryList(){
        const term = norm(catSearch.value).trim();
        const items = Array.from(categoryList.querySelectorAll(".category-item"));
        items.forEach((item) => {
          const text = norm(item.textContent);
          const ok = !term || text.includes(term);
          item.closest("li").style.display = ok ? "" : "none";
        });
      }

      function reviewList(){
        const cards = Array.from(grid.querySelectorAll(".card"));
        const visible = cards.filter((c) => c.style.display !== "none");
        return visible.map((card) => Number(card.dataset.idx)).filter((n) => !Number.isNaN(n));
      }

      function setupEvents(){
        q.addEventListener("input", () => {
          state.query = q.value;
          applyFilter();
        });

        scopeButtons.forEach((btn) => {
          btn.addEventListener("click", () => setScope(btn.dataset.scope));
        });

        openCategories.addEventListener("click", () => categoryModal.showModal());
        catSearch.addEventListener("input", updateCategoryList);

        catFavoritesOnly.addEventListener("change", () => {
          state.favoritesOnly = catFavoritesOnly.checked;
          toggleFavorites.classList.toggle("active", state.favoritesOnly);
          toggleFavorites.setAttribute("aria-pressed", String(state.favoritesOnly));
          applyFilter();
        });

        catClear.addEventListener("click", () => {
          state.category = "";
          state.favoritesOnly = false;
          catFavoritesOnly.checked = false;
          toggleFavorites.classList.remove("active");
          toggleFavorites.setAttribute("aria-pressed", "false");
          applyFilter();
        });

        categoryList.addEventListener("click", (e) => {
          const btn = e.target.closest(".category-item");
          if(!btn) return;
          state.category = btn.dataset.label || "";
          applyFilter();
          categoryModal.close();
        });

        toggleFavorites.addEventListener("click", () => {
          state.favoritesOnly = !state.favoritesOnly;
          toggleFavorites.classList.toggle("active", state.favoritesOnly);
          toggleFavorites.setAttribute("aria-pressed", String(state.favoritesOnly));
          catFavoritesOnly.checked = state.favoritesOnly;
          applyFilter();
        });


        openReview.addEventListener("click", () => {
          const list = reviewList();
          if(!list.length) return;
          const idx = Math.floor(Math.random() * list.length);
          openDetail(list[idx]);
        });
        randomGlyph.addEventListener("click", () => {
          if(!signs.length) return;
          const idx = Math.floor(Math.random() * signs.length);
          openDetail(idx);
        });
        debugToggle.addEventListener("click", async () => {
          const info = collectDebugInfo();
          debugContent.textContent = JSON.stringify(info, null, 2);
          debugPanel.showModal();
        });
        debugCopyInline.addEventListener("click", async () => {
          const text = debugContent.textContent || "";
          if(!text) return;
          try{
            await navigator.clipboard.writeText(text);
            showToast("Debug copied");
          }catch{
            showToast("Copy failed");
          }
        });
        debugHighlightFixed.addEventListener("click", () => {
          const toggled = document.documentElement.classList.toggle("debug-fixed");
          if(toggled){
            Array.from(document.querySelectorAll("*")).forEach((el) => {
              const cs = getComputedStyle(el);
              if(cs.position === "fixed"){
                el.setAttribute("data-fixed", "true");
              }
            });
            showToast("Fixed highlighted");
          }else{
            document.querySelectorAll("[data-fixed]").forEach((el) => el.removeAttribute("data-fixed"));
            showToast("Fixed cleared");
          }
        });


        detailModal.addEventListener("click", (e) => {
          const btn = e.target.closest("[data-copy]");
          if(!btn || !currentSign) return;
          const key = btn.dataset.copy;
          const value = key === "codepoint"
            ? currentSign.codepoint?.hex
            : key === "gardiner"
              ? currentSign.gardiner?.code
              : currentSign.codepoint?.char;
          if(!value) return;
          navigator.clipboard.writeText(value).then(() => showToast("Copied"));
        });

        grid.addEventListener("click", async (e) => {
          const btn = e.target.closest("[data-action]");
          if(!btn) return;
          const card = btn.closest(".card");
          if(!card) return;

          const idx = Number(card.dataset.idx);
          const sign = signs[idx];

          if(btn.dataset.action === "open"){
            openDetail(idx);
          }

          if(btn.dataset.action === "copy"){
            if(sign?.codepoint?.char){
              try{
                await navigator.clipboard.writeText(sign.codepoint.char);
                showToast("Glyph copied");
              }catch{
                showToast("Copy failed");
              }
            }
          }

          if(btn.dataset.action === "fav"){
            const id = sign.id;
            if(favorites.has(id)) favorites.delete(id);
            else favorites.add(id);
            saveFavorites();
            updateFavUI();
            applyFilter();
          }
        });
      }

      async function loadData(){
        const signRes = await fetch("/data/signs.json");
        signs = await signRes.json();
        total.textContent = String(signs.length);
        renderGrid();
        buildCategoryList();
        updateCategoryList();
        setupEvents();
      }

      loadData();
    </script>

    <style>
      @font-face{
        font-family: "Noto Sans Egyptian Hieroglyphs";
        src: url("/fonts/NotoSansEgyptianHieroglyphs-Regular.ttf") format("truetype");
        font-display: swap;
        unicode-range: U+13000-1342F, U+13460-1347F;
      }
      @font-face{
        font-family: "CodexHieroglyphs";
        src: url("/fonts/hieroglyphs.woff2?v=2") format("woff2");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }

      :root{
        color-scheme: light;
        --paper: #f4ecd8;
        --paper-dark: #e7dcc2;
        --ink: #2e2418;
        --muted: #5b4a36;
        --accent: #8b5e3c;
        --accent-2: #b7794a;
        --line: rgba(46,36,24,0.18);
      }
      html, body{ height: 100%; background: var(--paper); background-color: var(--paper); }
      html, body{
        overflow-x: hidden;
      }
      body{
        margin:0;
        font-family: "Cormorant Garamond", "Garamond", "Palatino Linotype", "Book Antiqua", serif;
        color: var(--ink);
        background: var(--paper);
        background-image:
          radial-gradient(1200px 800px at 10% -20%, rgba(255,255,255,0.8), transparent 60%),
          radial-gradient(900px 700px at 90% 0%, rgba(255,255,255,0.6), transparent 60%),
          repeating-linear-gradient(0deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02) 1px, transparent 1px, transparent 3px),
          repeating-linear-gradient(90deg, rgba(0,0,0,0.015), rgba(0,0,0,0.015) 1px, transparent 1px, transparent 4px);
        overflow-x: hidden;
        padding-bottom: env(safe-area-inset-bottom, 0px);
        background-color: var(--paper);
      }
      .wrap{
        max-width:1200px;
        margin:0 auto;
        padding:20px 18px 24px;
        min-height:100dvh;
        min-height:100svh;
        display:flex;
        flex-direction:column;
        gap:16px;
        overflow: visible !important;
        padding-bottom:24px !important;
      }
      .main, .content, .grid-wrap, .appShell{ overflow: visible !important; }

      .hero{ display:flex; flex-direction:column; gap:18px; }
      .title h1{ margin:0; font-size:34px; letter-spacing:0.8px; }
      .sub{ margin:6px 0 0; color: var(--muted); font-size:15px; }

      .panel{
        border:1px solid rgba(46,36,24,0.2);
        border-radius:20px;
        padding:20px;
        background:
          linear-gradient(180deg, rgba(255,255,255,0.76), rgba(255,255,255,0.32)),
          radial-gradient(120% 120% at 0% 0%, rgba(255,255,255,0.35), transparent 60%);
        box-shadow:
          0 18px 34px rgba(46,36,24,0.14),
          inset 0 0 0 1px rgba(255,255,255,0.45);
      }
      .panel-row{ display:flex; align-items:center; justify-content:space-between; gap:18px; flex-wrap:wrap; }
      .search{ display:flex; flex-direction:column; gap:6px; font-size:12px; color: var(--muted); }
      .search input{
        width:min(520px, 78vw);
        padding:12px 14px;
        border-radius:14px;
        border:1px solid rgba(46,36,24,0.22);
        background: rgba(255,255,255,0.86);
        color: var(--ink);
        outline:none;
      }
      .search.small input{ width:min(320px, 70vw); }
      .search input:focus{ border-color: var(--accent-2); box-shadow: 0 0 0 3px rgba(183,121,74,0.2); }
      .stats{ font-size:12px; color: var(--muted); }

      .scope{ align-items:center; }
      .scope-label{ font-size:12px; text-transform:uppercase; letter-spacing:0.18em; color: var(--muted); }
      .scope-options{ display:flex; gap:8px; flex-wrap:wrap; }
      .seg{
        border:1px solid rgba(46,36,24,0.22);
        background: rgba(255,255,255,0.72);
        color: var(--ink);
        border-radius:999px;
        padding:8px 14px;
        font-size:12px;
        cursor:pointer;
      }
      .seg.active{ border-color: var(--accent); color: #fef6e9; background: var(--accent); }

      .actions{ justify-content:flex-start; margin-top:12px; }
      .btn{
        border:1px solid var(--line);
        background: rgba(255,255,255,0.7);
        color: var(--ink);
        border-radius:12px;
        padding:10px 14px;
        cursor:pointer;
        font-weight:600;
        font-size:12px;
      }
      .btn.ghost{ background: transparent; }
      .btn.active{ border-color: var(--accent); color: #fef6e9; background: var(--accent); }

      .action-pills{ display:flex; gap:12px; flex-wrap:wrap; }
      :global(.pill){
        border:1px solid rgba(46,36,24,0.35);
        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(231,220,194,0.9));
        color: var(--ink);
        border-radius:999px;
        padding:9px 16px;
        font-size:12px;
        font-weight:700;
        letter-spacing:0.04em;
        text-transform:uppercase;
        cursor:pointer;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
      }
      :global(.card .pill){
        border:1px solid rgba(46,36,24,0.35) !important;
        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(231,220,194,0.9)) !important;
        color: var(--ink) !important;
        border-radius:999px !important;
        padding:9px 16px !important;
        font-size:12px !important;
        font-weight:700 !important;
        letter-spacing:0.04em !important;
        text-transform:uppercase !important;
        cursor:pointer !important;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6) !important;
        appearance:none !important;
        -webkit-appearance:none !important;
      }
      :global(.card .fav){ text-transform:none !important; padding:9px 14px !important; }
      :global(.card .pill:hover){ transform: translateY(-1px); }
      :global(.pill[aria-pressed="true"]){ background: var(--accent); color:#fef6e9; border-color: var(--accent); }

      :global(.grid){
        flex:1;
        min-height:0;
        overflow:auto;
        padding-right:4px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
        padding-top:52px;
        display:grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        column-gap:16px;
        row-gap:72px;
      }
      :global(.card){
        border:1px solid rgba(46,36,24,0.18);
        border-radius:18px;
        padding:18px;
        background:
          linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.68));
        box-shadow:
          0 14px 28px rgba(46,36,24,0.12),
          inset 0 0 0 1px rgba(255,255,255,0.5);
        display:flex;
        flex-direction:column;
        gap:14px;
        position: relative;
      }
      :global(.card:hover){
        transform: translateY(-2px);
        box-shadow:
          0 18px 34px rgba(46,36,24,0.14),
          inset 0 0 0 1px rgba(255,255,255,0.55);
      }
      :global(.card-head){
        display:flex !important;
        flex-direction:column !important;
        align-items:center !important;
      }
      :global(.glyph){
        font-family: "CodexHieroglyphs", "Noto Sans Egyptian Hieroglyphs", "Segoe UI Symbol", serif !important;
        text-align:center;
      }
      :global(.glyphWrap){
        width:100% !important;
        display:flex !important;
        justify-content:center !important;
        align-items:center !important;
        margin:8px 0 10px 0 !important;
        height:260px;
      }
      :global(.glyphWrap img){width:220px;height:220px;object-fit:contain;image-rendering:auto;}
      :global(.glyphWrap svg){width:220px;height:220px;display:block;}
      :global(.glyphWrap .glyph){
        font-size:220px !important;
        line-height:1 !important;
        transform: scale(1.15) !important;
        text-align:center !important;
        display:block !important;
      }
      :global(.fav){
        border:1px solid var(--line);
        background: rgba(255,255,255,0.6);
        color: var(--muted);
        border-radius:10px;
        padding:6px 8px;
        cursor:pointer;
      }
      :global(.fav.active){ color: #fef6e9; background: var(--accent); border-color: var(--accent); }
      :global(.meta .id){ font-family: "Courier New", monospace; font-size:12px; color: var(--muted); }
      :global(.card-title){ margin-top:4px; }
      :global(.meta .name){ font-size:16px; font-weight:700; }
      :global(.meta .category){ font-size:12px; color: var(--muted); }

      :global(.card-body){ font-size:14px; line-height:1.4; }
      :global(.lines){ display:grid; gap:6px; color: var(--muted); }

      :global(.actions){ display:flex; gap:10px; flex-wrap:wrap; }

      .modal{ border:none; padding:0; background: transparent; }
      .modal::backdrop{ background: rgba(45,34,22,0.28); }
      .modal-inner{
        width:min(820px, 92vw);
        border:1px solid rgba(46,36,24,0.2);
        border-radius:20px;
        background: rgba(255,255,255,0.97);
        padding:22px;
        color: var(--ink);
        max-height:84vh;
        overflow:auto;
        overflow-x:hidden;
        box-sizing:border-box;
      }
      .modal-wide{ width:min(960px, 94vw); }
      .modal-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:14px; }
      .mTitle{ font-size:18px; font-weight:700; }
      .mSub{ font-size:12px; color: var(--muted); }
      .close{
        border:1px solid var(--line);
        background: rgba(255,255,255,0.7);
        color: inherit;
        border-radius:12px;
        padding:8px 10px;
        cursor:pointer;
      }

      .modal-controls{ display:flex; flex-wrap:wrap; gap:14px; margin:12px 0 8px; align-items:flex-end; }
      .check{ display:flex; gap:8px; align-items:center; font-size:12px; color: var(--muted); }

      .category-list{
        list-style:none;
        padding:0;
        margin:8px 0 0;
        display:grid;
        gap:8px;
        max-height:60vh;
        overflow:auto;
      }
      .category-item{
        width:100%;
        border:1px solid rgba(46,36,24,0.2);
        background: rgba(255,255,255,0.86);
        color: var(--ink);
        border-radius:14px;
        padding:12px 16px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        cursor:pointer;
      }

      .mId{ font-family: "Courier New", monospace; font-size:12px; color: var(--muted); }
      .mName{ font-size:22px; font-weight:800; margin-top:2px; }
      .mCat{ font-size:12px; color: var(--muted); margin-top:2px; }
      .mCode{ margin:16px 0 10px; font-size:260px; line-height:1; text-align:center; }

      .detail-section{ margin-top:16px; }
      .detail-label{ font-size:12px; letter-spacing:0.08em; text-transform:uppercase; color: var(--muted); }
      .detail-row{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      .detail-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:14px; }
      .detail-key{ font-size:11px; color: var(--muted); text-transform:uppercase; letter-spacing:0.08em; }
      .detail-value{ font-size:14px; font-weight:600; line-height:1.4; }
      .detail-value, .line, .source-pointers{ overflow-wrap:anywhere; word-break:break-word; }
      .detail-actions{ margin-top:6px; }
      .glyph-actions{ display:flex; justify-content:center; margin-top:4px; }

      .detail-list{ margin-top:8px; }
      .bullet{ padding-left:18px; margin:0; }
      .missing{ color: var(--muted); font-size:12px; }
      .debug-content{
        white-space: pre-wrap;
        word-break: break-word;
        background: rgba(255,255,255,0.7);
        border:1px solid var(--line);
        border-radius:12px;
        padding:12px;
        font-size:12px;
        font-family: "Courier New", monospace;
        max-height:50vh;
        overflow:auto;
        max-width:100%;
      }
      .debug-fixed [data-fixed="true"]{
        outline: 3px solid #e53935 !important;
        outline-offset: 2px;
        background: rgba(229,57,53,0.08) !important;
      }


      .toast{ display:none !important; }

      body::after{ display:none; }

      /* HARD STOP: kill any decorative margin glyphs */
      .card::before,
      .card::after,
      .card-head::before,
      .card-head::after,
      .glyphWrap::before,
      .glyphWrap::after{
        content: none !important;
        display: none !important;
        background: none !important;
      }

      @media (max-width: 720px){
        .panel-row{ flex-direction:column; align-items:stretch; }
        .actions{ flex-direction:column; align-items:stretch; }
        .btn{ width:100%; }
        .grid{ padding-bottom: env(safe-area-inset-bottom, 0px); }
      }
    </style>
  </body>
</html>
